<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Entregas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest">
    <meta name="theme-color" content="#DC3545">
    
    <script>
 if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js') // com ./ no começo!
    .then(() => console.log("Service Worker registrado com sucesso."))
    .catch(err => console.error("Erro ao registrar Service Worker:", err));
}

        let entregas = JSON.parse(localStorage.getItem("entregas") || "[]");
        let historico = JSON.parse(localStorage.getItem("historico") || "[]");
        let historicoFiltradoAtual = [];

        let caixaTroco = JSON.parse(localStorage.getItem('caixaTroco'));
        if (!Array.isArray(caixaTroco)) {
            caixaTroco = [];
        }

        let gasolinaValor = JSON.parse(localStorage.getItem('gasolinaValor'));
        if (!Array.isArray(gasolinaValor)) {
            gasolinaValor = [];
        }

        function salvarCaixa() {
            const valor = parseFloat(document.getElementById('inputCaixaValor').value);
            const data = document.getElementById('inputCaixaData').value;

            if (isNaN(valor) || valor <= 0) {
                alert("Por favor, insira um valor numérico positivo para o caixa.");
                return;
            }
            if (!data) {
                alert("Por favor, selecione uma data para o caixa.");
                return;
            }

            caixaTroco.push({ valor, data });
            localStorage.setItem('caixaTroco', JSON.stringify(caixaTroco));
            atualizarCaixaGasolina();
            alert(`Valor do caixa salvo: R$ ${valor.toFixed(2)} | Data: ${formatarDataParaExibicao(data)}`);
            document.getElementById('inputCaixaValor').value = '';
            document.getElementById('inputCaixaData').value = '';
        }

        function salvarGasolina() {
            const valor = parseFloat(document.getElementById('inputGasolinaValor').value);
            const data = document.getElementById('inputGasolinaData').value;

            if (isNaN(valor) || valor <= 0) {
                alert("Por favor, insira um valor numérico positivo para a gasolina.");
                return;
            }
            if (!data) {
                alert("Por favor, selecione uma data para a gasolina.");
                return;
            }

            gasolinaValor.push({ valor, data });
            localStorage.setItem('gasolinaValor', JSON.stringify(gasolinaValor));
            atualizarCaixaGasolina();
            alert(`Valor da gasolina salvo: R$ ${valor.toFixed(2)} | Data: ${formatarDataParaExibicao(data)}`);
            document.getElementById('inputGasolinaValor').value = '';
            document.getElementById('inputGasolinaData').value = '';
        }

        function formatarDataParaExibicao(dataIso) {
            if (!dataIso) return '-';
            const [ano, mes, dia] = dataIso.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function calcularTotal(arr) {
            if (!Array.isArray(arr)) {
                return 0;
            }
            return arr.reduce((acc, item) => acc + item.valor, 0);
        }

        function atualizarCaixaGasolina() {
            let tempCaixaTroco = JSON.parse(localStorage.getItem('caixaTroco'));
            caixaTroco = Array.isArray(tempCaixaTroco) ? tempCaixaTroco : [];

            let tempGasolinaValor = JSON.parse(localStorage.getItem('gasolinaValor'));
            gasolinaValor = Array.isArray(tempGasolinaValor) ? tempGasolinaValor : [];

            document.getElementById('caixaResumoTotal').innerHTML = `R$ ${calcularTotal(caixaTroco).toFixed(2)}`;
            document.getElementById('gasolinaResumoTotal').innerHTML = `R$ ${calcularTotal(gasolinaValor).toFixed(2)}`;
        
            document.getElementById('inputCaixaValor').value = '';
            document.getElementById('inputCaixaData').value = '';
            document.getElementById('inputGasolinaValor').value = '';
            document.getElementById('inputGasolinaData').value = '';

            renderizarDetalhes('caixa');
            renderizarDetalhes('gasolina');
        }

        function toggleDetalhes(tipo) {
            const detalhesDiv = document.getElementById(`detalhes${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            detalhesDiv.classList.toggle('hidden');
            renderizarDetalhes(tipo);
        }

        function renderizarDetalhes(tipo) {
            const listaUl = document.getElementById(`listaDetalhes${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            listaUl.innerHTML = '';
            const dados = tipo === 'caixa' ? caixaTroco : gasolinaValor;

            if (!Array.isArray(dados)) {
                listaUl.innerHTML = '<li>Erro: Dados de lançamento não são válidos.</li>';
                return;
            }

            if (dados.length === 0) {
                listaUl.innerHTML = '<li>Nenhum lançamento registrado para esta semana.</li>';
                return;
            }

            dados.forEach(item => {
                listaUl.innerHTML += `
                    <li>
                        <span>${formatarDataParaExibicao(item.data)}</span>
                        <span class="valor">R$ ${item.valor.toFixed(2)}</span>
                    </li>
                `;
            });
        }

        function showPage(id) {
            ["principal", "pagos", "naoPagos", "naoColetados", "caixa", "registros"].forEach(p => {
                document.getElementById(p).classList.add("hidden");
            });
            document.getElementById(id).classList.remove("hidden");
            if (id === "caixa") {
                calcularCaixa();
                atualizarCaixaGasolina();
            } else {
                document.getElementById('detalhesCaixa').classList.add('hidden');
                document.getElementById('detalhesGasolina').classList.add('hidden');
            }
            if (id === "registros") {
                document.getElementById("filtroDataInicio").value = "";
                document.getElementById("filtroDataFim").value = "";
                aplicarFiltroHistorico();
            }
            if (id === "pagos" || id === "naoPagos") renderizarPagos();
            if (id === "naoColetados") renderizarNaoColetados();
            if (id === "principal") renderizar();
            closeNav(); // Fechar o menu ao selecionar uma página
        }

        function openNav() {
            document.getElementById("mainNav").classList.add("open");
            document.getElementById("overlay").classList.add("open");
            document.getElementById("hamburgerBtn").classList.add("open");
        }

        function closeNav() {
            document.getElementById("mainNav").classList.remove("open");
            document.getElementById("overlay").classList.remove("open");
            document.getElementById("hamburgerBtn").classList.remove("open");
        }
        
        function adicionarEntrega() {
            const nome = document.getElementById("nome").value.trim();
            const telefone = document.getElementById("telefone").value.trim();
            const descricao = document.getElementById("descricao").value.trim();
            const valor = parseFloat(document.getElementById("valor").value);
            const pagamento = document.getElementById("pagamento").value;
            const pago = document.getElementById("pago").checked;
            const formaPagamento = pago ? pagamento : "";
            const dataAtual = new Date();
            
            const dataFormatada = dataAtual.toLocaleDateString('pt-BR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            }).replace(',', '');

            if (!nome || isNaN(valor) || (pago && !pagamento)) {
                return alert("Preencha todos os campos corretamente. Se marcou pago, escolha forma de pagamento.");
            }

            entregas.push({
                nome,
                telefone,
                descricao,
                valor,
                pagamento: formaPagamento,
                pago,
                data: dataFormatada,
                emergencial: false,
                coletado: false
            });

            salvar();

            document.getElementById("nome").value = "";
            document.getElementById("telefone").value = "";
            document.getElementById("descricao").value = "";
            document.getElementById("valor").value = "";
            document.getElementById("pagamento").value = "";
            document.getElementById("pago").checked = false;
        }
        
        function salvar() {
            localStorage.setItem("entregas", JSON.stringify(entregas));
            renderizar();
            renderizarPagos();
            renderizarNaoColetados();
        }
        
        function marcarEmergencial(i) {
            entregas[i].emergencial = !entregas[i].emergencial;
            salvar();
        }
        
        function excluir(i) {
            if (confirm("Excluir coleta?")) {
                entregas.splice(i, 1);
                salvar();
            }
        }
        
        function fecharSemana() {
            if (!confirm("Fechar a semana? Esta ação irá limpar as entregas atuais e movê-las para o histórico.")) return;
            
            historico.push({ 
                semana: new Date().toISOString(), 
                dados: JSON.parse(JSON.stringify(entregas)), 
                caixaLancamentos: JSON.parse(JSON.stringify(caixaTroco)),
                gasolinaLancamentos: JSON.parse(JSON.stringify(gasolinaValor))
            });
            
            entregas = [];
            
            caixaTroco = [];
            gasolinaValor = [];
            
            localStorage.setItem("entregas", "[]");
            localStorage.setItem("historico", JSON.stringify(historico));
            localStorage.setItem("caixaTroco", JSON.stringify(caixaTroco));
            localStorage.setItem("gasolinaValor", JSON.stringify(gasolinaValor));
            
            renderizar();
            atualizarCaixaGasolina();
            renderizarNaoColetados();
            alert("Semana fechada. Dados salvos em registros e caixa/gasolina zerados.");
        }
        
        function atualizarCampo(i, campo, valor) {
            if (campo === "valor") {
                valor = parseFloat(valor);
                if (isNaN(valor)) return;
            }
            entregas[i][campo] = valor;
            if (campo === "pago" && !valor) {
                entregas[i].pagamento = "";
            }
            salvar();
        }
        
        function togglePago(i) {
            entregas[i].pago = !entregas[i].pago;
            if (!entregas[i].pago) entregas[i].pagamento = "";
            salvar();
        }

        function toggleColetado(i) {
            entregas[i].coletado = !entregas[i].coletado;
            salvar();
        }
        
        function renderizar() {
            const tabela = document.getElementById("tabela-principal");
            tabela.innerHTML = "";
            if (entregas.length === 0) {
                tabela.innerHTML = `<tr><td colspan='9'>Nenhum registro na semana atual.</td></tr>`;
                return;
            }
            entregas.forEach((e, i) => {
                tabela.innerHTML += `
             <tr>
    <td><input type="text" value="${e.nome}" onchange="atualizarCampo(${i}, 'nome', this.value)" /></td>
    <td><input type="text" value="${e.telefone || ''}" onchange="atualizarCampo(${i}, 'telefone', this.value)" /></td>
    <td><input type="text" value="${e.descricao || ''}" onchange="atualizarCampo(${i}, 'descricao', this.value)" /></td>
    <td><input type="number" value="${e.valor.toFixed(2)}" onchange="atualizarCampo(${i}, 'valor', this.value)" /></td>
    <td>
        <select onchange="atualizarCampo(${i}, 'pagamento', this.value)">
            <option value="">Selecione</option>
            <option ${e.pagamento === 'PGA' ? 'selected' : ''}>PGA</option>
            <option ${e.pagamento === 'PGR' ? 'selected' : ''}>PGR</option>
            <option ${e.pagamento === 'PIX' ? 'selected' : ''}>PIX</option>
        </select>
    </td>
    <td><input type="checkbox" ${e.pago ? 'checked' : ''} onclick="togglePago(${i})" /></td>
    <td><input type="checkbox" ${e.coletado ? 'checked' : ''} onclick="toggleColetado(${i})" /></td>
    <td>${e.data}</td>
    <td>
        <button class="small" onclick="marcarEmergencial(${i})">
            <span class="badge ${e.emergencial ? 'emergencial' : 'principal'}">
                ${e.emergencial ? 'Gilnei' : 'Alfredo'}
            </span>
            
        </button>
        <button class="small" onclick="excluir(${i})">X</button>
    </td>
</tr>

                    </tr>
                `;
            });
            renderizarPagos();
            renderizarNaoColetados();
        }
        
       function renderizarPagos() {
    const tabelaPagos = document.getElementById("tabela-pagos");
    const tabelaNaoPagos = document.getElementById("tabela-naoPagos");
    const listaTelefonesNaoPagosSpan = document.getElementById("listaTelefones"); // Renomeado para clareza

    // Limpa ambas as tabelas antes de renderizar
    tabelaPagos.innerHTML = "";
    tabelaNaoPagos.innerHTML = "";
    listaTelefonesNaoPagosSpan.textContent = ""; // Limpa a lista de telefones também

    const pagos = entregas.filter(e => e.pago);
    const naoPagos = entregas.filter(e => !e.pago);

    // --- Renderização da Tabela de Pagos ---
    if (pagos.length === 0) {
        tabelaPagos.innerHTML = `<tr><td colspan='7' style="text-align:center;">Nenhum cliente pago no momento.</td></tr>`;
    } else {
        pagos.forEach(e => {
            tabelaPagos.innerHTML += `
                <tr>
                    <td>${e.nome || '-'}</td>
                    <td>${e.telefone || '-'}</td>
                    <td>${e.descricao || '-'}</td>
                    <td>R$ ${e.valor ? e.valor.toFixed(2) : '0.00'}</td>
                    <td>${e.pagamento || '-'}</td>
                    <td>${e.pago ? 'Sim' : 'Não'}</td>
                    <td>${e.data || '-'}</td>
                </tr>
            `;
        });
    }

    // --- Renderização da Tabela de Não Pagos ---
    let telefonesParaMensagemGeral = [];

    if (naoPagos.length === 0) {
        tabelaNaoPagos.innerHTML = `<tr><td colspan='7' style="text-align:center;">Nenhum cliente não pago no momento.</td></tr>`;
    } else {
        naoPagos.forEach((e, i) => {
            // Apenas coleta telefones se existirem para a lista geral
            if (e.telefone) {
                telefonesParaMensagemGeral.push(e.telefone.replace(/\D/g, ''));
            }

            // Mensagem personalizada para o WhatsApp individual
            const mensagemWhatsApp = `Olá ${e.nome || 'cliente'}! Gostaríamos de lembrar que sua pendência conosco no valor de R$ ${e.valor ? e.valor.toFixed(2) : '0.00'} referente a "${e.descricao || 'uma entrega'}" ainda não foi paga. Por favor, entre em contato para regularizar. Obrigado!`;

            // HTML para o botão do WhatsApp (renderiza apenas se tiver telefone)
            const whatsappButtonHtml = e.telefone ? `
                <a href="https://wa.me/55${e.telefone.replace(/\D/g, '')}?text=${encodeURIComponent(mensagemWhatsApp)}"
                   target="_blank"
                   class="whatsapp-btn small"
                   title="Enviar WhatsApp para ${e.nome || 'este cliente'}">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="white">
                        <path d="M12.04 2C7.38 2 3.63 5.75 3.63 10.42C3.63 12.09 4.09 13.6 4.88 14.93L3.5 19.5L8.23 18.2C9.44 18.88 10.79 19.24 12.04 19.24C16.7 19.24 20.46 15.48 20.46 10.82C20.46 6.16 16.7 2 12.04 2ZM15.99 14.73C15.76 15.09 15.11 15.16 14.7 15.04C14.28 14.93 12.63 14.13 12.33 14.03C12.02 13.93 11.72 13.96 11.49 14.21C11.26 14.47 10.59 15.17 10.35 15.42C10.11 15.68 9.87 15.71 9.45 15.48C9.03 15.25 7.64 14.06 6.55 12.18C5.69 10.74 5.43 9.94 5.66 9.58C5.89 9.23 6.18 9.13 6.42 9.07C6.61 9.01 6.81 9 7 9C7.19 9 7.42 9.08 7.6 9.27C7.81 9.49 8.08 9.77 8.32 10.03C8.56 10.28 8.77 10.32 8.97 10.22C9.17 10.12 9.78 9.85 10.49 9.17C11.31 8.36 11.95 7.45 12.18 7.07C12.4 6.7 12.64 6.8 12.87 6.9C13.06 6.99 14.06 7.49 14.26 7.67C14.46 7.84 14.59 7.95 14.83 8.1C15.06 8.24 15.29 8.3 15.49 8.2C15.68 8.1 16.14 7.66 16.35 7.4C16.57 7.15 16.79 7.19 17.02 7.28C17.26 7.37 18.06 7.74 18.21 7.82C18.36 7.9 18.49 7.98 18.52 8.06C18.55 8.14 18.55 8.29 18.48 8.44C18.41 8.59 17.9 9.09 17.15 9.82C16.4 10.55 15.76 11.19 15.65 11.45C15.54 11.71 15.54 11.83 15.74 12.2C15.94 12.57 16.2 12.78 16.4 12.98C16.61 13.18 16.73 13.4 16.66 13.62C16.59 13.85 16.22 14.39 15.99 14.73Z"/>
                    </svg>
                </a>
            ` : `<span style="color: #6c757d;">Sem contato</span>`; // Se não tiver telefone
            
            tabelaNaoPagos.innerHTML += `
                <tr>
                    <td>${e.nome || '-'}</td>
                    <td>${e.telefone || '-'}</td>
                    <td>${e.descricao || '-'}</td>
                    <td>R$ ${e.valor ? e.valor.toFixed(2) : '0.00'}</td>
                    <td>${e.pago ? 'Sim' : 'Não'}</td>
                    <td>${e.data || '-'}</td>
                    <td>${whatsappButtonHtml}</td> </tr>
            `;
        });
    }

    // Atualiza a lista de telefones para envio em massa
    listaTelefonesNaoPagosSpan.textContent = telefonesParaMensagemGeral.join(', ') || 'Nenhum telefone disponível.';
}
        
        function renderizarNaoColetados() {
            const tabelaNaoColetados = document.getElementById("tabela-naoColetados");
            tabelaNaoColetados.innerHTML = "";
            const naoColetados = entregas.filter(e => !e.coletado);

            const listaTelefonesNaoColetados = document.getElementById("listaTelefonesNaoColetados");
            listaTelefonesNaoColetados.innerHTML = "";

            if (naoColetados.length === 0) {
                tabelaNaoColetados.innerHTML = `<tr><td colspan='6'>Nenhuma mercadoria não coletada no momento.</td></tr>`;
                return;
            }

            let telefones = [];
            naoColetados.forEach((e) => {
                const originalIndex = entregas.findIndex(item => item === e);
                
                tabelaNaoColetados.innerHTML += `
                    <tr>
                        <td>${e.nome}</td>
                        <td>${e.telefone || '-'}</td>
                        <td>${e.descricao || '-'}</td>
                        <td>R$ ${e.valor.toFixed(2)}</td>
                        <td>${e.data}</td>
                        <td>
                            <button class="small" onclick="toggleColetado(${originalIndex})">Marcar Coletado</button>
                            <button class="small" onclick="excluir(${originalIndex})">X</button>
                        </td>
                    </tr>
                `;
                if (e.telefone) {
                    telefones.push(e.telefone);
                }
            });

            listaTelefonesNaoColetados.textContent = telefones.join(', ');
        }
        
        function calcularCaixa() {
            const totalBruto = entregas.reduce((acc, e) => acc + e.valor, 0);
            const emergencialTotal = entregas.filter(e => e.emergencial).length * 10;
            const subtotal = totalBruto - emergencialTotal;
            const comissao = subtotal * 0.22;

            document.getElementById("totalBruto").textContent = totalBruto.toFixed(2);
            document.getElementById("emergencialTotal").textContent = emergencialTotal.toFixed(2);
            document.getElementById("subtotal").textContent = subtotal.toFixed(2);
            document.getElementById("comissao").textContent = comissao.toFixed(2);
        }
        
        function aplicarFiltroHistorico() {
            const inicio = document.getElementById("filtroDataInicio").value;
            const fim = document.getElementById("filtroDataFim").value;
            const historicoDiv = document.getElementById("historico");
            historicoDiv.innerHTML = "";

            if (historico.length === 0) {
                historicoDiv.innerHTML = `<p style="text-align: center; font-style: italic; color: #999;">Nenhum histórico registrado.</p>`;
                return;
            }

            let resultadosFiltrados = [];

            historico.forEach((semanaRecord, semanaIndex) => {
                const dataSemana = new Date(semanaRecord.semana);
                const dataInicio = inicio ? new Date(inicio + 'T00:00:00') : null;
                const dataFim = fim ? new Date(fim + 'T23:59:59') : null;

                let incluirSemana = true;
                if (dataInicio && dataSemana < dataInicio) {
                    incluirSemana = false;
                }
                if (dataFim && dataSemana > dataFim) {
                    incluirSemana = false;
                }

                if (incluirSemana) {
                    resultadosFiltrados.push({ ...semanaRecord, originalIndex: semanaIndex });
                }
            });

            historicoFiltradoAtual = resultadosFiltrados;

            if (resultadosFiltrados.length === 0) {
                historicoDiv.innerHTML = `<p style="text-align: center; font-style: italic; color: #999;">Nenhum registro encontrado para o período selecionado.</p>`;
                return;
            }

            resultadosFiltrados.forEach((semanaRecord, idx) => {
                const semanaTitulo = `Semana de ${new Date(semanaRecord.semana).toLocaleDateString('pt-BR')}`;
                let semanaContent = `<h3>${semanaTitulo}</h3>`;

                const totalBrutoSemana = semanaRecord.dados.reduce((acc, e) => acc + e.valor, 0);
                const emergencialSemana = semanaRecord.dados.filter(e => e.emergencial).length * 10;
                const subtotalSemana = totalBrutoSemana + emergencialSemana;
                const comissaoSemana = subtotalSemana * 0.22;

                semanaContent += `
                    <div class="resumo-extra" style="border-top: none; padding-top: 0;">
                        <p>Total Bruto: <strong>R$ ${totalBrutoSemana.toFixed(2)}</strong></p>
                        <p>Emergenciais: <strong>R$ ${emergencialSemana.toFixed(2)}</strong></p>
                        <p>Subtotal: <strong>R$ ${subtotalSemana.toFixed(2)}</strong></p>
                        <p>Comissão: <strong>R$ ${comissaoSemana.toFixed(2)}</strong></p>
                    </div>
                `;

                semanaContent += `
                    <table style="width: 100%; margin-top: 10px;">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleSelectAllHistorico(this, ${idx})" aria-label="Selecionar todos da semana" /></th>
                                <th>Nome</th>
                                <th>Valor (R$)</th>
                                <th>Pago</th>
                                <th>Coletado</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                if (semanaRecord.dados.length === 0) {
                    semanaContent += `<tr><td colspan="6">Nenhum registro de entrega para esta semana.</td></tr>`;
                } else {
                    semanaRecord.dados.forEach((entrega, entregaIdx) => {
                        semanaContent += `
                            <tr>
                                <td><input type="checkbox" class="historico-checkbox" data-semana-idx="${idx}" data-entrega-idx="${entregaIdx}" aria-label="Selecionar registro" /></td>
                                <td>${entrega.nome}</td>
                                <td>R$ ${entrega.valor.toFixed(2)}</td>
                                <td>${entrega.pago ? 'Sim' : 'Não'}</td>
                                <td>${entrega.coletado ? 'Sim' : 'Não'}</td>
                                <td>${entrega.data}</td>
                            </tr>
                        `;
                    });
                }
                semanaContent += `</tbody></table>`;

                const totalCaixaSemana = calcularTotal(semanaRecord.caixaLancamentos);
                const totalGasolinaSemana = calcularTotal(semanaRecord.gasolinaLancamentos);

                semanaContent += `
                    <div class="resumo-extra">
                        <p>Total Caixa (troco): <strong id="caixaResumoTotalSemana_${idx}">R$ ${totalCaixaSemana.toFixed(2)}</strong></p>
                        <div class="detalhes-container">
                            <h4>Detalhes do Caixa (troco) da Semana</h4>
                            <ul>
                `;
                if (semanaRecord.caixaLancamentos && semanaRecord.caixaLancamentos.length > 0) {
                    semanaRecord.caixaLancamentos.forEach(item => {
                        semanaContent += `<li><span>${formatarDataParaExibicao(item.data)}</span> <span class="valor">R$ ${item.valor.toFixed(2)}</span></li>`;
                    });
                } else {
                    semanaContent += `<li>Nenhum lançamento de caixa para esta semana.</li>`;
                }
                semanaContent += `
                            </ul>
                        </div>
                        <p style="margin-top:10px;">Total Gasolina: <strong id="gasolinaResumoTotalSemana_${idx}">R$ ${totalGasolinaSemana.toFixed(2)}</strong></p>
                        <div class="detalhes-container">
                            <h4>Detalhes da Gasolina da Semana</h4>
                            <ul>
                `;
                if (semanaRecord.gasolinaLancamentos && semanaRecord.gasolinaLancamentos.length > 0) {
                    semanaRecord.gasolinaLancamentos.forEach(item => {
                        semanaContent += `<li><span>${formatarDataParaExibicao(item.data)}</span> <span class="valor">R$ ${item.valor.toFixed(2)}</span></li>`;
                    });
                } else {
                    semanaContent += `<li>Nenhum lançamento de gasolina para esta semana.</li>`;
                }
                semanaContent += `
                            </ul>
                        </div>
                    </div>
                `;
                historicoDiv.innerHTML += `<div class="historico-semana">${semanaContent}</div>`;
            });
        }

        function toggleSelectAllHistorico(checkbox, semanaIndex) {
            const checkboxes = document.querySelectorAll(`#historico [data-semana-idx="${semanaIndex}"]`);
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function apagarSelecionados() {
            if (!confirm("Tem certeza que deseja apagar os registros selecionados?")) return;

            const checkboxes = document.querySelectorAll('.historico-checkbox:checked');
            const paraRemover = [];

            checkboxes.forEach(cb => {
                const semanaIdx = parseInt(cb.dataset.semanaIdx);
                const entregaIdx = parseInt(cb.dataset.entregaIdx);
                paraRemover.push({ semanaIdx, entregaIdx });
            });

            const agrupadoPorSemana = paraRemover.reduce((acc, item) => {
                acc[item.semanaIdx] = acc[item.semanaIdx] || [];
                acc[item.semanaIdx].push(item.entregaIdx);
                return acc;
            }, {});

            for (const semanaIdxStr in agrupadoPorSemana) {
                const semanaIdx = parseInt(semanaIdxStr);
                const indicesEntregas = agrupadoPorSemana[semanaIdx].sort((a, b) => b - a);

                indicesEntregas.forEach(entregaIdx => {
                    if (historico[semanaIdx] && historico[semanaIdx].dados) {
                        historico[semanaIdx].dados.splice(entregaIdx, 1);
                    }
                });
            }

            localStorage.setItem("historico", JSON.stringify(historico));
            aplicarFiltroHistorico();
            alert("Registros selecionados apagados!");
        }

        function apagarFiltrados() {
            if (!confirm("Tem certeza que deseja apagar TODOS os registros filtrados?")) return;

            const semanasParaManter = historico.filter((_, idx) => {
                return !historicoFiltradoAtual.some(filteredRecord => filteredRecord.originalIndex === idx);
            });

            historico = semanasParaManter;

            localStorage.setItem("historico", JSON.stringify(historico));
            aplicarFiltroHistorico();
            alert("Registros filtrados apagados!");
        }

        function apagarTodosHistorico() {
            if (confirm("Tem certeza que deseja apagar TODO o histórico de registros? Esta ação é irreversível.")) {
                historico = [];
                localStorage.setItem("historico", "[]");
                aplicarFiltroHistorico();
                alert("Todo o histórico de registros foi apagado.");
            }
        }

        function enviarMensagemGeral() {
    const naoPagosComTelefone = entregas.filter(e => !e.pago && e.telefone);
    if (naoPagosComTelefone.length === 0) {
        alert("Não há clientes não pagos e com telefone registrado para enviar mensagem.");
        return;
    }

    let mensagemDetalhadaParaCopiar = "Olá! Gostaríamos de lembrar que sua pendência conosco ainda não foi paga.\n\nDetalhes:\n";
    naoPagosComTelefone.forEach(e => {
        mensagemDetalhadaParaCopiar += `\n- Cliente: ${e.nome || 'Nome não informado'}\n  Descrição: ${e.descricao || 'N/A'}\n  Valor: R$ ${e.valor ? e.valor.toFixed(2) : '0.00'}\n`;
    });
    mensagemDetalhadaParaCopiar += "\nPor favor, entre em contato para regularizar. Obrigado!";

    const listaTelefonesFormatada = naoPagosComTelefone
                                    .map(e => e.telefone.replace(/\D/g, ''))
                                    .join(', '); // Junta os telefones com vírgula para fácil cópia

    const confirmSend = confirm(
        "Será gerada uma mensagem geral e a lista de telefones para os clientes não pagos.\n\n" +
        "1. A mensagem detalhada será copiada para sua área de transferência.\n" +
        "2. A lista de telefones ('" + listaTelefonesFormatada + "') será exibida para você copiar e colar no WhatsApp.\n\n" +
        "Deseja continuar?"
    );

    if (confirmSend) {
        // Tenta copiar a mensagem detalhada para a área de transferência
        navigator.clipboard.writeText(mensagemDetalhadaParaCopiar)
            .then(() => {
                alert("Mensagem detalhada copiada para a área de transferência!\n\nAgora, por favor, copie a lista de telefones (" + listaTelefonesFormatada + ") e cole no WhatsApp para enviar.");
                // Opcional: Você pode tentar abrir o WhatsApp Web aqui, mas sem um destinatário específico.
                // window.open('https://web.whatsapp.com/', '_blank');
            })
            .catch(err => {
                console.error('Erro ao copiar a mensagem: ', err);
                alert("Não foi possível copiar a mensagem automaticamente. Por favor, copie o texto abaixo manualmente e a lista de telefones:\n\n" + mensagemDetalhadaParaCopiar + "\n\nTelefones: " + listaTelefonesFormatada);
            });
    }
}

function enviarMensagemNaoColetadosGeral() {
    const naoColetados = entregas.filter(e => !e.coletado && e.telefone);
    if (naoColetados.length === 0) {
        alert("Não há clientes com mercadorias não coletadas e telefone registrado para enviar mensagem.");
        return;
    }

    let mensagemDetalhadaParaCopiar = "Olá! Gostaríamos de lembrar que sua mercadoria conosco ainda não foi coletada.\n\nDetalhes:\n";
    naoColetados.forEach(e => {
        mensagemDetalhadaParaCopiar += `\n- Cliente: ${e.nome || 'Nome não informado'}\n  Descrição: ${e.descricao || 'N/A'}\n  Valor: R$ ${e.valor ? e.valor.toFixed(2) : '0.00'}\n`;
    });
    mensagemDetalhadaParaCopiar += "\nPor favor, entre em contato para agendar a coleta. Obrigado!";

    const listaTelefonesFormatada = naoColetados
                                    .map(e => e.telefone.replace(/\D/g, ''))
                                    .join(', ');

    const confirmSend = confirm(
        "Será gerada uma mensagem geral e a lista de telefones para os clientes com mercadorias não coletadas.\n\n" +
        "1. A mensagem detalhada será copiada para sua área de transferência.\n" +
        "2. A lista de telefones ('" + listaTelefonesFormatada + "') será exibida para você copiar e colar no WhatsApp.\n\n" +
        "Deseja continuar?"
    );

    if (confirmSend) {
        navigator.clipboard.writeText(mensagemDetalhadaParaCopiar)
            .then(() => {
                alert("Mensagem detalhada copiada para a área de transferência!\n\nAgora, por favor, copie a lista de telefones (" + listaTelefonesFormatada + ") e cole no WhatsApp para enviar.");
            })
            .catch(err => {
                console.error('Erro ao copiar a mensagem: ', err);
                alert("Não foi possível copiar a mensagem automaticamente. Por favor, copie o texto abaixo manualmente e a lista de telefones:\n\n" + mensagemDetalhadaParaCopiar + "\n\nTelefones: " + listaTelefonesFormatada);
            });
    }
}

    </script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <button id="hamburgerBtn" class="hamburger-btn" onclick="openNav()" aria-label="Abrir menu">
                <span class="hamburger-icon"></span>
                <span class="hamburger-icon"></span>
                <span class="hamburger-icon"></span>
            </button>
            <a href="#" onclick="showPage('principal'); return false;" class="logo-link" aria-label="Voltar para a página principal">
                <img src="icons/r_grande_dividido.png" alt="Logo da Empresa R" loading="lazy">
            </a>
            <h1>REDEMIX TRANSPORTES</h1>
        </header>

        <nav id="mainNav" class="main-nav">
            <ul class="nav-list">
                <li><button onclick="showPage('principal')" aria-controls="principal" role="tab">Principal</button></li>
                <li><button onclick="showPage('pagos')" aria-controls="pagos" role="tab">Pagos</button></li>
                <li><button onclick="showPage('naoPagos')" aria-controls="naoPagos" role="tab">Não Pagos</button></li>
                <li><button onclick="showPage('naoColetados')" aria-controls="naoColetados" role="tab">Não Coletados</button></li>
                <li><button onclick="showPage('caixa')" aria-controls="caixa" role="tab">Caixa</button></li>
                <li><button onclick="showPage('registros')" aria-controls="registros" role="tab">Registros</button></li>
            </ul>
        </nav>

        <div id="overlay" class="overlay" onclick="closeNav()"></div>

        <div id="principal" role="tabpanel" tabindex="0">
            <div style="display:flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 10px;">
                <input type="text" id="nome" placeholder="Nome" aria-label="Nome" />
                <input type="text" id="telefone" placeholder="Telefone" aria-label="Telefone" />
                <input type="text" id="descricao" placeholder="Descrição" aria-label="Descrição" />
                <input type="number" id="valor" placeholder="Valor (R$)" min="0" step="0.01" aria-label="Valor" />
                <select id="pagamento" aria-label="Forma de pagamento">
                    <option value="">Forma de pagamento</option>
                    <option>PGA</option>
                    <option>PGR</option>
                    <option>PIX</option>
                </select>
                <label for="pago" style="align-self: center;">Pago: <input type="checkbox" id="pago" aria-label="Pago" /></label>
                <button onclick="adicionarEntrega()" aria-label="Adicionar entrega">Adicionar</button>
                <button onclick="fecharSemana()" aria-label="Fechar semana">Fechar Semana</button>
            </div>

            <table aria-describedby="Tabela de entregas principal">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th>Descrição</th>
                        <th>Valor (R$)</th>
                        <th>Pagamento</th>
                        <th>Pago</th>
                        <th>Coletado</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela-principal"></tbody>
            </table>
        </div>

        <div id="pagos" class="hidden" role="tabpanel" tabindex="0">
            <h2>Clientes Pagos</h2>
            <table aria-describedby="Tabela de clientes pagos">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th>Descrição</th>
                        <th>Valor (R$)</th>
                        <th>Pagamento</th>
                        <th>Pago</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody id="tabela-pagos"></tbody>
            </table>
        </div>

        <div id="naoPagos" class="hidden" role="tabpanel" tabindex="0">
    <h2>Clientes Não Pagos</h2>
    <table aria-describedby="Tabela de clientes não pagos">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Descrição</th>
                <th>Valor (R$)</th>
                <th>Pago</th>
                <th>Data</th>
                <th>Ações</th> </tr>
        </thead>
        <tbody id="tabela-naoPagos"></tbody>
    </table>
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="enviarMensagemGeral()">Enviar Mensagem Geral (WhatsApp)</button>
        <p>Telefones dos clientes não pagos (para envio em massa): <span id="listaTelefones"></span></p>
    </div>
</div>

        <div id="naoColetados" class="hidden" role="tabpanel" tabindex="0">
            <h2>Mercadorias Não Coletadas</h2>
            <table aria-describedby="Tabela de mercadorias não coletadas">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th>Descrição</th>
                        <th>Valor (R$)</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela-naoColetados"></tbody>
            </table>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="enviarMensagemNaoColetadosGeral()">Enviar Mensagem Geral (WhatsApp)</button>
                <p>Telefones dos clientes com mercadorias não coletadas (para envio em massa): <span id="listaTelefonesNaoColetados"></span></p>
            </div>
        </div>

        <div id="caixa" class="hidden" role="tabpanel" tabindex="0">
            <h2>Resumo da Semana</h2>
            <p>Total Bruto: <strong>R$ <span id="totalBruto"></span></strong></p>
            <p>Emergenciais (R$10,00 por coleta): <strong>R$ <span id="emergencialTotal"></span></strong></p>
            <p>Subtotal (com taxa emergencial): <strong>R$ <span id="subtotal"></span></strong></p>
            <p>Comissão (22%): <strong>R$ <span id="comissao"></span></strong></p>

            <div class="resumo-extra">
                <p>Total Caixa (troco): <strong id="caixaResumoTotal">R$ 0,00</strong> <button class="small" onclick="toggleDetalhes('caixa')">+ Detalhes</button></p>
                <div id="detalhesCaixa" class="detalhes-container hidden">
                    <h4>Detalhes do Caixa (troco)</h4>
                    <ul id="listaDetalhesCaixa"></ul>
                </div>

                <p>Total Gasolina: <strong id="gasolinaResumoTotal">R$ 0,00</strong> <button class="small" onclick="toggleDetalhes('gasolina')">+ Detalhes</button></p>
                <div id="detalhesGasolina" class="detalhes-container hidden">
                    <h4>Detalhes da Gasolina</h4>
                    <ul id="listaDetalhesGasolina"></ul>
                </div>
            </div>

            <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #ccc;">

            <div class="caixa-gasolina-container">
                <div class="info-card caixa">
                    <h3>💰 Lançar Caixa (troco)</h3>
                    <input type="number" id="inputCaixaValor" placeholder="Valor (R$)" min="0" step="0.01">
                    <input type="date" id="inputCaixaData">
                    <button onclick="salvarCaixa()">Salvar Caixa</button>
                </div>

                <div class="info-card gasolina">
                    <h3>⛽ Lançar Gasolina</h3>
                    <input type="number" id="inputGasolinaValor" placeholder="Valor (R$)" min="0" step="0.01">
                    <input type="date" id="inputGasolinaData">
                    <button onclick="salvarGasolina()">Salvar Gasolina</button>
                </div>
            </div>
        </div>

        <div id="registros" class="hidden" role="tabpanel" tabindex="0">
            <h2>Histórico de Registros</h2>
            <div class="filtro-container">
                <label for="filtroDataInicio" class="filtro-item">
                    <span>Data Início:</span> <input type="date" id="filtroDataInicio" aria-label="Filtro data início" />
                </label>
                <label for="filtroDataFim" class="filtro-item">
                    <span>Data Fim:</span> <input type="date" id="filtroDataFim" aria-label="Filtro data fim" />
                </label>
                <button onclick="aplicarFiltroHistorico()" aria-label="Aplicar filtro">Aplicar Filtro</button>
            </div>
            
            <div class="botoes-historico-container">
                <button onclick="apagarSelecionados()" aria-label="Apagar registros selecionados">Apagar Selecionados</button>
                <button onclick="apagarFiltrados()" aria-label="Apagar registros filtrados">Apagar Filtrados</button>
                <button onclick="apagarTodosHistorico()" aria-label="Apagar todos os registros">Apagar Todos</button>
            </div>
            
            <div id="historico"></div>
        </div>
    </div> </body>
</html>
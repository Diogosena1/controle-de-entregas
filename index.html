<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Entregas</title>
    <style>
        /* Reset b√°sico */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #eaeff5;
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            color: #222;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        /* Container geral para as abas */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Permite que os bot√µes quebrem a linha */
        }

        .tabs button {
            background-color: #4972ff;
            border: none;
            color: white;
            padding: 10px 18px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 7px rgba(73,114,255,0.4);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            flex-shrink: 0; /* Impede que os bot√µes encolham muito */
            font-size: 1em; /* Ajusta o tamanho da fonte para mobile */
        }

        .tabs button:hover,
        .tabs button:focus {
            background-color: #2a51d0;
            box-shadow: 0 6px 10px rgba(42,81,208,0.7);
            outline: none;
        }

        .hidden {
            display: none;
        }

        /* Card para se√ß√µes */
        #principal, #pagos, #naoPagos, #naoColetados, #caixa, #registros { /* Adicionado #naoColetados */
            background: white;
            max-width: 1100px;
            margin: 0 auto 40px;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
            min-height: 320px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #1a237e;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Inputs e selects */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%; /* Largura total dentro do container */
            max-width: 220px; /* Limita a largura em telas maiores */
            padding: 8px 12px;
            margin: 6px 10px 12px 0;
            border: 1.8px solid #bbb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.25s ease;
            font-weight: 500;
            color: #444;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #4972ff;
            outline: none;
            box-shadow: 0 0 6px #8ea6ffaa;
        }

        label {
            font-weight: 600;
            color: #555;
            user-select: none;
            margin-right: 10px;
            white-space: nowrap; /* Impede que a label "Pago:" quebre linha desnecessariamente */
        }

        label > input[type="checkbox"] {
            transform: scale(1.3);
            margin-left: 6px;
            cursor: pointer;
        }

        /* Bot√µes principais */
        button {
            background-color: #4972ff;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
            box-shadow: 0 3px 8px rgba(73,114,255,0.5);
            user-select: none;
        }

        button:hover,
        button:focus {
            background-color: #2a51d0;
            outline: none;
        }

        /* Bot√µes pequenos para a√ß√µes */
        button.small {
            padding: 5px 8px;
            font-size: 13px;
            margin: 0 3px;
            box-shadow: 0 2px 5px rgba(73,114,255,0.4);
        }

        /* Tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
            font-size: 14px;
            display: block; /* Permite scroll horizontal */
            overflow-x: auto; /* Adiciona scroll horizontal se a tabela for muito larga */
            white-space: nowrap; /* Impede que o conte√∫do da c√©lula quebre linha */
        }

        thead {
            background-color: #4972ff;
            color: white;
            user-select: none;
        }

        thead th {
            padding: 12px 10px;
            font-weight: 700;
            border-right: 1px solid #3d60d1;
        }

        thead th:last-child {
            border-right: none;
        }

        tbody tr:nth-child(even) {
            background-color: #f7f9ff;
        }

        tbody tr:hover {
            background-color: #dde5ff;
            cursor: default;
        }

        tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
            text-align: center;
        }

        /* Inputs dentro da tabela */
        tbody input[type="text"],
        tbody input[type="number"],
        tbody select {
            width: 95%;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1.6px solid #ccc;
            transition: border-color 0.25s ease;
        }

        tbody input[type="text"]:focus,
        tbody input[type="number"]:focus,
        tbody select:focus {
            border-color: #4972ff;
            outline: none;
            box-shadow: 0 0 5px #7b94ffcc;
        }

        tbody input[type="checkbox"] {
            transform: scale(1.3);
            cursor: pointer;
        }

        /* Texto para "nenhum registro" */
        tbody td[colspan] {
            font-style: italic;
            color: #999;
        }

        /* Container filtro registros (ATUALIZADO) */
        #registros > .filtro-container { /* Adicionando uma classe para o div de filtro */
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px; /* Aumentado o gap para melhor espa√ßamento */
            margin-bottom: 25px; /* Ajuste na margem inferior */
            justify-content: center;
        }

        #registros .filtro-item { /* Novo estilo para cada item de filtro (label + input) */
            display: flex;
            align-items: center;
            gap: 5px; /* Espa√ßamento entre a label e o input dentro do item */
        }

        #registros .filtro-item input[type="date"] {
            max-width: 150px; /* Limita um pouco a largura do input de data */
            margin: 0; /* Remove margens extras que podem estar empurrando */
            padding: 6px 10px; /* Ajusta padding */
            font-size: 14px;
        }
        
        #registros > .botoes-historico-container { /* Adicionando uma classe para o div dos bot√µes de hist√≥rico */
            display: flex;
            justify-content: center;
            gap: 10px; /* Espa√ßamento entre os bot√µes */
            margin-bottom: 20px;
            flex-wrap: wrap; /* Para quebrar a linha em telas pequenas */
        }

        #registros .botoes-historico-container button {
            margin-top: 0; /* Garante que n√£o haja margem extra em cima */
        }


        /* Estilos para Caixa e Gasolina */
        .caixa-gasolina-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Permite que os cards quebrem a linha */
        }

        .info-card {
            flex: 1; /* Permite que os cards se expandam */
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-width: 280px; /* Garante um tamanho m√≠nimo para n√£o ficar muito pequeno */
            background: #fdfdfd;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-card.caixa {
            background: #eaf8e8;
        }

        .info-card.gasolina {
            background: #fbeaea;
        }

        .info-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .info-card p {
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
            color: #555;
        }

        .info-card input[type="number"],
        .info-card input[type="date"] {
            max-width: 100%; /* Ocupa 100% da largura do card */
            margin: 5px 0;
        }

        .info-card button {
            margin-top: 10px;
            align-self: flex-end;
        }

        /* Estilo para o resumo de caixa e gasolina dentro da aba 'Caixa' */
        .resumo-extra {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }

        .resumo-extra p {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #444;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* Permite que o texto e o bot√£o quebrem a linha */
        }

        .resumo-extra p strong {
            color: #1a237e;
        }

        .resumo-extra button {
            margin-top: 0;
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 5px;
        }

        /* Estilos para a se√ß√£o de detalhes */
        .detalhes-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .detalhes-container h4 {
            margin-top: 0;
            color: #4972ff;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .detalhes-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .detalhes-container li {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }

        .detalhes-container li:last-child {
            margin-bottom: 0;
        }

        .detalhes-container li span {
            font-weight: 500;
            color: #333;
        }
        .detalhes-container li .valor {
            font-weight: 700;
            color: #1a237e;
        }

        /* RESPONSIVIDADE - MEDIA QUERIES */
        @media(max-width: 768px) { /* Ajustado para 768px para ser mais abrangente */
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            .tabs button {
                padding: 8px 15px;
                font-size: 0.95em;
            }

            #principal, #pagos, #naoPagos, #naoColetados, #caixa, #registros { /* Adicionado #naoColetados */
                padding: 15px;
                margin-bottom: 20px;
            }

            /* Inputs do formul√°rio principal */
            #principal > div {
                flex-direction: column; /* Empilha os inputs */
                align-items: center; /* Centraliza os itens empilhados */
                gap: 8px; /* Reduz o espa√ßamento */
            }

            input[type="text"],
            input[type="number"],
            input[type="date"],
            select {
                max-width: 95%; /* Ocupa mais largura em telas menores */
                margin: 5px 0; /* Ajusta a margem */
            }

            label {
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            button {
                width: 100%; /* Bot√µes principais ocupam toda a largura */
                max-width: 300px; /* Limita a largura para n√£o ficarem muito grandes */
                margin-top: 15px;
            }

            button.small {
                width: auto; /* Bot√µes pequenos voltam a ser auto-largura */
                max-width: none;
                margin: 5px;
            }

            /* Container de Caixa e Gasolina */
            .caixa-gasolina-container {
                flex-direction: column; /* Empilha os cards */
                gap: 15px; /* Ajusta o espa√ßamento */
            }

            .info-card {
                min-width: unset; /* Remove o min-width para que ele se adapte melhor */
                width: 100%; /* Ocupa a largura total do container */
                max-width: 400px; /* Limita a largura em telas muito pequenas */
            }
            
            /* Ajusta tabelas para mobile */
            table {
                font-size: 13px; /* Fonte um pouco menor para economizar espa√ßo */
            }
            thead th, tbody td {
                padding: 8px 5px; /* Menor padding */
            }

            tbody input[type="text"],
            tbody input[type="number"],
            tbody select {
                width: 90%; /* Ajusta inputs dentro da tabela */
                font-size: 13px;
                padding: 5px;
            }

            .resumo-extra p {
                flex-direction: column; /* Empilha texto e bot√£o de detalhes */
                align-items: flex-start;
                gap: 5px;
            }

            /* RESPONSIVIDADE PARA REGISTROS (ATUALIZADO) */
            #registros .filtro-item {
                flex-direction: column; /* Empilha label e input em telas menores */
                align-items: flex-start; /* Alinha labels √† esquerda */
                gap: 2px; /* Reduz gap ao empilhar */
                width: 100%; /* Ocupa largura total */
                max-width: 250px; /* Limita a largura para cada item do filtro */
            }

            #registros .filtro-item input[type="date"] {
                max-width: 100%; /* Ocupa 100% da largura do filtro-item */
            }

            #registros > .filtro-container {
                flex-direction: column; /* Empilha todo o container do filtro */
                gap: 15px; /* Ajusta o gap entre os itens empilhados */
            }

            #registros > .botoes-historico-container {
                flex-direction: column; /* Empilha os bot√µes em telas menores */
                gap: 10px; /* Ajusta o espa√ßamento */
                align-items: center; /* Centraliza os bot√µes empilhados */
            }
            #registros .botoes-historico-container button {
                width: 90%; /* Ajusta largura dos bot√µes empilhados */
                max-width: 250px;
            }
        }

        @media(max-width: 480px) { /* Ajustes para telas ainda menores, como iPhones SE */
            h1 {
                font-size: 1.5em;
            }
            .tabs button {
                font-size: 0.85em;
                padding: 7px 12px;
            }
            #principal, #pagos, #naoPagos, #naoColetados, #caixa, #registros { /* Adicionado #naoColetados */
                padding: 10px;
            }
            h2 {
                font-size: 1.2em;
            }
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/controle-de-entregas/service-worker.js')
                .then(() => console.log("Service Worker registrado com sucesso."))
                .catch(err => console.error("Erro ao registrar Service Worker:", err));
        }
    </script>
</head>
<body>

<h1>Controle de Entregas</h1>

<div class="tabs" role="tablist" aria-label="Navega√ß√£o de p√°ginas">
    <button onclick="showPage('principal')" aria-controls="principal" role="tab">Principal</button>
    <button onclick="showPage('pagos')" aria-controls="pagos" role="tab">Pagos</button>
    <button onclick="showPage('naoPagos')" aria-controls="naoPagos" role="tab">N√£o Pagos</button>
    <button onclick="showPage('naoColetados')" aria-controls="naoColetados" role="tab">N√£o Coletados</button> <button onclick="showPage('caixa')" aria-controls="caixa" role="tab">Caixa</button>
    <button onclick="showPage('registros')" aria-controls="registros" role="tab">Registros</button>
</div>

<div id="principal" role="tabpanel" tabindex="0">
    <div style="display:flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 10px;">
        <input type="text" id="nome" placeholder="Nome" aria-label="Nome" />
        <input type="text" id="telefone" placeholder="Telefone" aria-label="Telefone" />
        <input type="text" id="descricao" placeholder="Descri√ß√£o" aria-label="Descri√ß√£o" />
        <input type="number" id="valor" placeholder="Valor (R$)" min="0" step="0.01" aria-label="Valor" />
        <select id="pagamento" aria-label="Forma de pagamento">
            <option value="">Forma de pagamento</option>
            <option>PGA</option>
            <option>PGR</option>
            <option>PIX</option>
        </select>
        <label for="pago" style="align-self: center;">Pago: <input type="checkbox" id="pago" aria-label="Pago" /></label>
        <button onclick="adicionarEntrega()" aria-label="Adicionar entrega">Adicionar</button>
        <button onclick="fecharSemana()" aria-label="Fechar semana">Fechar Semana</button>
    </div>

    <table aria-describedby="Tabela de entregas principal">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Descri√ß√£o</th>
                <th>Valor (R$)</th>
                <th>Pagamento</th>
                <th>Pago</th>
                <th>Coletado</th> <th>Data</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabela-principal"></tbody>
    </table>
</div>

<div id="pagos" class="hidden" role="tabpanel" tabindex="0">
    <h2>Clientes Pagos</h2>
    <table aria-describedby="Tabela de clientes pagos">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Descri√ß√£o</th>
                <th>Valor (R$)</th>
                <th>Pagamento</th>
                <th>Pago</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody id="tabela-pagos"></tbody>
    </table>
</div>

<div id="naoPagos" class="hidden" role="tabpanel" tabindex="0">
    <h2>Clientes N√£o Pagos</h2>
    <table aria-describedby="Tabela de clientes n√£o pagos">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Descri√ß√£o</th>
                <th>Valor (R$)</th>
                <th>Pago</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody id="tabela-naoPagos"></tbody>
    </table>
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="enviarMensagemGeral()">Enviar Mensagem Geral (WhatsApp)</button>
        <p>Telefones dos clientes n√£o pagos (para envio em massa): <span id="listaTelefones"></span></p>
    </div>
</div>

<div id="naoColetados" class="hidden" role="tabpanel" tabindex="0">
    <h2>Mercadorias N√£o Coletadas</h2>
    <table aria-describedby="Tabela de mercadorias n√£o coletadas">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Descri√ß√£o</th>
                <th>Valor (R$)</th>
                <th>Data</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabela-naoColetados"></tbody>
    </table>
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="enviarMensagemNaoColetadosGeral()">Enviar Mensagem Geral (WhatsApp)</button>
        <p>Telefones dos clientes com mercadorias n√£o coletadas (para envio em massa): <span id="listaTelefonesNaoColetados"></span></p>
    </div>
</div>
<div id="caixa" class="hidden" role="tabpanel" tabindex="0">
    <h2>Resumo da Semana</h2>
    <p>Total Bruto: <strong>R$ <span id="totalBruto"></span></strong></p>
    <p>Emergenciais (R$10,00 por coleta): <strong>R$ <span id="emergencialTotal"></span></strong></p>
    <p>Subtotal (com taxa emergencial): <strong>R$ <span id="subtotal"></span></strong></p>
    <p>Comiss√£o (22%): <strong>R$ <span id="comissao"></span></strong></p>

    <div class="resumo-extra">
        <p>Total Caixa (troco): <strong id="caixaResumoTotal">R$ 0,00</strong> <button class="small" onclick="toggleDetalhes('caixa')">+ Detalhes</button></p>
        <div id="detalhesCaixa" class="detalhes-container hidden">
            <h4>Detalhes do Caixa (troco)</h4>
            <ul id="listaDetalhesCaixa"></ul>
        </div>

        <p>Total Gasolina: <strong id="gasolinaResumoTotal">R$ 0,00</strong> <button class="small" onclick="toggleDetalhes('gasolina')">+ Detalhes</button></p>
        <div id="detalhesGasolina" class="detalhes-container hidden">
            <h4>Detalhes da Gasolina</h4>
            <ul id="listaDetalhesGasolina"></ul>
        </div>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #ccc;">

    <div class="caixa-gasolina-container">
        <div class="info-card caixa">
            <h3>üí∞ Lan√ßar Caixa (troco)</h3>
            <input type="number" id="inputCaixaValor" placeholder="Valor (R$)" min="0" step="0.01">
            <input type="date" id="inputCaixaData">
            <button onclick="salvarCaixa()">Salvar Caixa</button>
        </div>

        <div class="info-card gasolina">
            <h3>‚õΩ Lan√ßar Gasolina</h3>
            <input type="number" id="inputGasolinaValor" placeholder="Valor (R$)" min="0" step="0.01">
            <input type="date" id="inputGasolinaData">
            <button onclick="salvarGasolina()">Salvar Gasolina</button>
        </div>
    </div>
</div>

<div id="registros" class="hidden" role="tabpanel" tabindex="0">
    <h2>Hist√≥rico de Registros</h2>
    <div class="filtro-container">
        <label for="filtroDataInicio" class="filtro-item">
            <span>Data In√≠cio:</span> <input type="date" id="filtroDataInicio" aria-label="Filtro data in√≠cio" />
        </label>
        <label for="filtroDataFim" class="filtro-item">
            <span>Data Fim:</span> <input type="date" id="filtroDataFim" aria-label="Filtro data fim" />
        </label>
        <button onclick="aplicarFiltroHistorico()" aria-label="Aplicar filtro">Aplicar Filtro</button>
    </div>
    
    <div class="botoes-historico-container">
        <button onclick="apagarSelecionados()" aria-label="Apagar registros selecionados">Apagar Selecionados</button>
        <button onclick="apagarFiltrados()" aria-label="Apagar registros filtrados">Apagar Filtrados</button>
        <button onclick="apagarTodosHistorico()" aria-label="Apagar todos os registros">Apagar Todos</button>
    </div>
    
    <div id="historico"></div>
</div>

<script>
    let entregas = JSON.parse(localStorage.getItem("entregas") || "[]");
    let historico = JSON.parse(localStorage.getItem("historico") || "[]");
    let historicoFiltradoAtual = []; // Guarda o filtro atual para apagar filtrados

    let caixaTroco = JSON.parse(localStorage.getItem('caixaTroco'));
    if (!Array.isArray(caixaTroco)) {
        caixaTroco = [];
    }

    let gasolinaValor = JSON.parse(localStorage.getItem('gasolinaValor'));
    if (!Array.isArray(gasolinaValor)) {
        gasolinaValor = [];
    }

    function salvarCaixa() {
        const valor = parseFloat(document.getElementById('inputCaixaValor').value);
        const data = document.getElementById('inputCaixaData').value;

        if (isNaN(valor) || valor <= 0) {
            alert("Por favor, insira um valor num√©rico positivo para o caixa.");
            return;
        }
        if (!data) {
            alert("Por favor, selecione uma data para o caixa.");
            return;
        }

        caixaTroco.push({ valor, data });
        localStorage.setItem('caixaTroco', JSON.stringify(caixaTroco));
        atualizarCaixaGasolina(); // Atualiza a exibi√ß√£o e os inputs
        alert(`Valor do caixa salvo: R$ ${valor.toFixed(2)} | Data: ${formatarDataParaExibicao(data)}`);
        // Limpa os campos ap√≥s salvar
        document.getElementById('inputCaixaValor').value = '';
        document.getElementById('inputCaixaData').value = '';
    }

    function salvarGasolina() {
        const valor = parseFloat(document.getElementById('inputGasolinaValor').value);
        const data = document.getElementById('inputGasolinaData').value;

        if (isNaN(valor) || valor <= 0) {
            alert("Por favor, insira um valor num√©rico positivo para a gasolina.");
            return;
        }
        if (!data) {
            alert("Por favor, selecione uma data para a gasolina.");
            return;
        }

        gasolinaValor.push({ valor, data });
        localStorage.setItem('gasolinaValor', JSON.stringify(gasolinaValor));
        atualizarCaixaGasolina(); // Atualiza a exibi√ß√£o e os inputs
        alert(`Valor da gasolina salvo: R$ ${valor.toFixed(2)} | Data: ${formatarDataParaExibicao(data)}`);
        // Limpa os campos ap√≥s salvar
        document.getElementById('inputGasolinaValor').value = '';
        document.getElementById('inputGasolinaData').value = '';
    }

    function formatarDataParaExibicao(dataIso) {
        if (!dataIso) return '-';
        const [ano, mes, dia] = dataIso.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function calcularTotal(arr) {
        if (!Array.isArray(arr)) {
            return 0;
        }
        return arr.reduce((acc, item) => acc + item.valor, 0);
    }

    function atualizarCaixaGasolina() {
        let tempCaixaTroco = JSON.parse(localStorage.getItem('caixaTroco'));
        caixaTroco = Array.isArray(tempCaixaTroco) ? tempCaixaTroco : [];

        let tempGasolinaValor = JSON.parse(localStorage.getItem('gasolinaValor'));
        gasolinaValor = Array.isArray(tempGasolinaValor) ? tempGasolinaValor : [];

        document.getElementById('caixaResumoTotal').innerHTML = `R$ ${calcularTotal(caixaTroco).toFixed(2)}`;
        document.getElementById('gasolinaResumoTotal').innerHTML = `R$ ${calcularTotal(gasolinaValor).toFixed(2)}`;
    
        document.getElementById('inputCaixaValor').value = '';
        document.getElementById('inputCaixaData').value = '';
        document.getElementById('inputGasolinaValor').value = '';
        document.getElementById('inputGasolinaData').value = '';

        renderizarDetalhes('caixa');
        renderizarDetalhes('gasolina');
    }

    function toggleDetalhes(tipo) {
        const detalhesDiv = document.getElementById(`detalhes${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        detalhesDiv.classList.toggle('hidden');
        renderizarDetalhes(tipo);
    }

    function renderizarDetalhes(tipo) {
        const listaUl = document.getElementById(`listaDetalhes${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        listaUl.innerHTML = '';
        const dados = tipo === 'caixa' ? caixaTroco : gasolinaValor;

        if (!Array.isArray(dados)) {
            listaUl.innerHTML = '<li>Erro: Dados de lan√ßamento n√£o s√£o v√°lidos.</li>';
            return;
        }

        if (dados.length === 0) {
            listaUl.innerHTML = '<li>Nenhum lan√ßamento registrado para esta semana.</li>';
            return;
        }

        dados.forEach(item => {
            listaUl.innerHTML += `
                <li>
                    <span>${formatarDataParaExibicao(item.data)}</span>
                    <span class="valor">R$ ${item.valor.toFixed(2)}</span>
                </li>
            `;
        });
    }

    function showPage(id) {
        ["principal", "pagos", "naoPagos", "naoColetados", "caixa", "registros"].forEach(p => { // Adicionado "naoColetados"
            document.getElementById(p).classList.add("hidden");
        });
        document.getElementById(id).classList.remove("hidden");
        if (id === "caixa") {
            calcularCaixa();
            atualizarCaixaGasolina();
        } else {
            document.getElementById('detalhesCaixa').classList.add('hidden');
            document.getElementById('detalhesGasolina').classList.add('hidden');
        }
        if (id === "registros") {
            document.getElementById("filtroDataInicio").value = "";
            document.getElementById("filtroDataFim").value = "";
            aplicarFiltroHistorico();
        }
        if (id === "pagos" || id === "naoPagos") renderizarPagos(); // renderizarPagos j√° cuida dos pagos e naoPagos
        if (id === "naoColetados") renderizarNaoColetados(); // Chamada para a nova fun√ß√£o
        if (id === "principal") renderizar(); // Mantido para garantir que a principal seja sempre atualizada
    }
    
    function adicionarEntrega() {
        const nome = document.getElementById("nome").value.trim();
        const telefone = document.getElementById("telefone").value.trim();
        const descricao = document.getElementById("descricao").value.trim();
        const valor = parseFloat(document.getElementById("valor").value);
        const pagamento = document.getElementById("pagamento").value;
        const pago = document.getElementById("pago").checked;
        const formaPagamento = pago ? pagamento : "";
        const dataAtual = new Date();
        
        const dataFormatada = dataAtual.toLocaleDateString('pt-BR', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }).replace(',', '');

        if (!nome || isNaN(valor) || (pago && !pagamento)) {
            return alert("Preencha todos os campos corretamente. Se marcou pago, escolha forma de pagamento.");
        }

        entregas.push({
            nome,
            telefone,
            descricao,
            valor,
            pagamento: formaPagamento,
            pago,
            data: dataFormatada,
            emergencial: false,
            coletado: false // NOVO CAMPO: Inicialmente false
        });

        salvar();

        document.getElementById("nome").value = "";
        document.getElementById("telefone").value = "";
        document.getElementById("descricao").value = "";
        document.getElementById("valor").value = "";
        document.getElementById("pagamento").value = "";
        document.getElementById("pago").checked = false;
    }
    
    function salvar() {
        localStorage.setItem("entregas", JSON.stringify(entregas));
        renderizar(); // Garante que a tabela principal seja atualizada
        renderizarPagos(); // Garante que a tabela de pagos/nao pagos seja atualizada
        renderizarNaoColetados(); // Garante que a tabela de nao coletados seja atualizada
    }
    
    function marcarEmergencial(i) {
        entregas[i].emergencial = !entregas[i].emergencial;
        salvar();
    }
    
    function excluir(i) {
        if (confirm("Excluir coleta?")) {
            entregas.splice(i, 1);
            salvar();
        }
    }
    
    function fecharSemana() {
        if (!confirm("Fechar a semana? Esta a√ß√£o ir√° limpar as entregas atuais e mov√™-las para o hist√≥rico.")) return;
        
        historico.push({ 
            semana: new Date().toISOString(), 
            dados: JSON.parse(JSON.stringify(entregas)), 
            caixaLancamentos: JSON.parse(JSON.stringify(caixaTroco)),
            gasolinaLancamentos: JSON.parse(JSON.stringify(gasolinaValor))
        });
        
        entregas = [];
        
        caixaTroco = [];
        gasolinaValor = [];
        
        localStorage.setItem("entregas", "[]");
        localStorage.setItem("historico", JSON.stringify(historico));
        localStorage.setItem("caixaTroco", JSON.stringify(caixaTroco));
        localStorage.setItem("gasolinaValor", JSON.stringify(gasolinaValor));
        
        renderizar();
        atualizarCaixaGasolina();
        renderizarNaoColetados(); // Limpa tamb√©m a de n√£o coletados
        alert("Semana fechada. Dados salvos em registros e caixa/gasolina zerados.");
    }
    
    function atualizarCampo(i, campo, valor) {
        if (campo === "valor") {
            valor = parseFloat(valor);
            if (isNaN(valor)) return;
        }
        entregas[i][campo] = valor;
        if (campo === "pago" && !valor) { // Se desmarcou pago, limpa forma de pagamento
            entregas[i].pagamento = "";
        }
        salvar();
    }
    
    function togglePago(i) {
        entregas[i].pago = !entregas[i].pago;
        if (!entregas[i].pago) entregas[i].pagamento = ""; // Se desmarcou pago, limpa forma de pagamento
        salvar();
    }

    // NOVA FUN√á√ÉO PARA MARCAR/DESMARCAR COLETADO
    function toggleColetado(i) {
        entregas[i].coletado = !entregas[i].coletado;
        salvar(); // Salva o estado atualizado e re-renderiza as tabelas
    }
    
    function renderizar() {
        const tabela = document.getElementById("tabela-principal");
        tabela.innerHTML = "";
        if (entregas.length === 0) {
            tabela.innerHTML = `<tr><td colspan='9'>Nenhum registro na semana atual.</td></tr>`; // Alterado colspan para 9
            return;
        }
        entregas.forEach((e, i) => {
            tabela.innerHTML += `
                <tr>
                    <td><input type="text" value="${e.nome}" onchange="atualizarCampo(${i}, 'nome', this.value)" /></td>
                    <td><input type="text" value="${e.telefone || ''}" onchange="atualizarCampo(${i}, 'telefone', this.value)" /></td>
                    <td><input type="text" value="${e.descricao || ''}" onchange="atualizarCampo(${i}, 'descricao', this.value)" /></td>
                    <td><input type="number" value="${e.valor.toFixed(2)}" onchange="atualizarCampo(${i}, 'valor', this.value)" /></td>
                    <td>
                        <select onchange="atualizarCampo(${i}, 'pagamento', this.value)">
                            <option value="">Selecione</option>
                            <option ${e.pagamento === 'PGA' ? 'selected' : ''}>PGA</option>
                            <option ${e.pagamento === 'PGR' ? 'selected' : ''}>PGR</option>
                            <option ${e.pagamento === 'PIX' ? 'selected' : ''}>PIX</option>
                        </select>
                    </td>
                    <td><input type="checkbox" ${e.pago ? 'checked' : ''} onclick="togglePago(${i})" /></td>
                    <td><input type="checkbox" ${e.coletado ? 'checked' : ''} onclick="toggleColetado(${i})" /></td> <td>${e.data}</td>
                    <td>
                        <button class="small" onclick="marcarEmergencial(${i})">R$10</button>
                        <button class="small" onclick="excluir(${i})">X</button>
                    </td>
                </tr>
            `;
        });
        // Essas chamadas s√£o importantes para manter as outras tabelas sincronizadas
        renderizarPagos();
        renderizarNaoColetados();
    }
    
    function renderizarPagos() {
        const tabelaPagos = document.getElementById("tabela-pagos");
        const tabelaNaoPagos = document.getElementById("tabela-naoPagos");
        tabelaPagos.innerHTML = "";
        tabelaNaoPagos.innerHTML = "";

        const listaTelefones = document.getElementById("listaTelefones");
        listaTelefones.innerHTML = "";
        let telefonesNaoPagos = [];

        const pagos = entregas.filter(e => e.pago);
        const naoPagos = entregas.filter(e => !e.pago);

        if (pagos.length === 0) {
            tabelaPagos.innerHTML = `<tr><td colspan='7'>Nenhum cliente pago no momento.</td></tr>`;
        } else {
            pagos.forEach(e => {
                tabelaPagos.innerHTML += `
                    <tr>
                        <td>${e.nome}</td>
                        <td>${e.telefone || '-'}</td>
                        <td>${e.descricao || '-'}</td>
                        <td>R$ ${e.valor.toFixed(2)}</td>
                        <td>${e.pagamento || '-'}</td>
                        <td>${e.pago ? 'Sim' : 'N√£o'}</td>
                        <td>${e.data}</td>
                    </tr>
                `;
            });
        }

        if (naoPagos.length === 0) {
            tabelaNaoPagos.innerHTML = `<tr><td colspan='6'>Nenhum cliente n√£o pago no momento.</td></tr>`;
        } else {
            naoPagos.forEach(e => {
                tabelaNaoPagos.innerHTML += `
                    <tr>
                        <td>${e.nome}</td>
                        <td>${e.telefone || '-'}</td>
                        <td>${e.descricao || '-'}</td>
                        <td>R$ ${e.valor.toFixed(2)}</td>
                        <td>${e.pago ? 'Sim' : 'N√£o'}</td>
                        <td>${e.data}</td>
                    </tr>
                `;
                if (e.telefone) {
                    telefonesNaoPagos.push(e.telefone);
                }
            });
        }
        listaTelefones.textContent = telefonesNaoPagos.join(', ');
    }

    // NOVA FUN√á√ÉO PARA RENDERIZAR N√ÉO COLETADOS
    function renderizarNaoColetados() {
        const tabelaNaoColetados = document.getElementById("tabela-naoColetados");
        tabelaNaoColetados.innerHTML = "";
        const naoColetados = entregas.filter(e => !e.coletado); // Filtra os n√£o coletados

        const listaTelefonesNaoColetados = document.getElementById("listaTelefonesNaoColetados");
        listaTelefonesNaoColetados.innerHTML = "";

        if (naoColetados.length === 0) {
            tabelaNaoColetados.innerHTML = `<tr><td colspan='6'>Nenhuma mercadoria n√£o coletada no momento.</td></tr>`;
            return;
        }

        let telefones = [];
        naoColetados.forEach((e) => { // Removido o 'i' aqui, pois n√£o precisamos do √≠ndice do array filtrado, mas sim do original
            // Encontra o √≠ndice original no array 'entregas' para as fun√ß√µes de a√ß√£o
            const originalIndex = entregas.findIndex(item => item === e);
            
            tabelaNaoColetados.innerHTML += `
                <tr>
                    <td>${e.nome}</td>
                    <td>${e.telefone || '-'}</td>
                    <td>${e.descricao || '-'}</td>
                    <td>R$ ${e.valor.toFixed(2)}</td>
                    <td>${e.data}</td>
                    <td>
                        <button class="small" onclick="toggleColetado(${originalIndex})">Marcar Coletado</button>
                        <button class="small" onclick="excluir(${originalIndex})">X</button>
                    </td>
                </tr>
            `;
            if (e.telefone) {
                telefones.push(e.telefone);
            }
        });

        listaTelefonesNaoColetados.textContent = telefones.join(', ');
    }
    
    function calcularCaixa() {
        // Seu c√≥digo existente para calcular caixa
        const totalBruto = entregas.reduce((acc, e) => acc + e.valor, 0);
        const emergencialTotal = entregas.filter(e => e.emergencial).length * 10;
        const subtotal = totalBruto + emergencialTotal;
        const comissao = subtotal * 0.22;

        document.getElementById("totalBruto").textContent = totalBruto.toFixed(2);
        document.getElementById("emergencialTotal").textContent = emergencialTotal.toFixed(2);
        document.getElementById("subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("comissao").textContent = comissao.toFixed(2);
    }
    
    function aplicarFiltroHistorico() {
        const inicio = document.getElementById("filtroDataInicio").value;
        const fim = document.getElementById("filtroDataFim").value;
        const historicoDiv = document.getElementById("historico");
        historicoDiv.innerHTML = "";

        if (historico.length === 0) {
            historicoDiv.innerHTML = `<p style="text-align: center; font-style: italic; color: #999;">Nenhum hist√≥rico registrado.</p>`;
            return;
        }

        let resultadosFiltrados = [];

        historico.forEach((semanaRecord, semanaIndex) => {
            const dataSemana = new Date(semanaRecord.semana);
            const dataInicio = inicio ? new Date(inicio + 'T00:00:00') : null;
            const dataFim = fim ? new Date(fim + 'T23:59:59') : null;

            let incluirSemana = true;
            if (dataInicio && dataSemana < dataInicio) {
                incluirSemana = false;
            }
            if (dataFim && dataSemana > dataFim) {
                incluirSemana = false;
            }

            if (incluirSemana) {
                resultadosFiltrados.push({ ...semanaRecord, originalIndex: semanaIndex });
            }
        });

        historicoFiltradoAtual = resultadosFiltrados; // Guarda para apagar filtrados

        if (resultadosFiltrados.length === 0) {
            historicoDiv.innerHTML = `<p style="text-align: center; font-style: italic; color: #999;">Nenhum registro encontrado para o per√≠odo selecionado.</p>`;
            return;
        }

        resultadosFiltrados.forEach((semanaRecord, idx) => {
            const semanaTitulo = `Semana de ${new Date(semanaRecord.semana).toLocaleDateString('pt-BR')}`;
            let semanaContent = `<h3>${semanaTitulo}</h3>`;

            // Adiciona totais da semana
            const totalBrutoSemana = semanaRecord.dados.reduce((acc, e) => acc + e.valor, 0);
            const emergencialSemana = semanaRecord.dados.filter(e => e.emergencial).length * 10;
            const subtotalSemana = totalBrutoSemana + emergencialSemana;
            const comissaoSemana = subtotalSemana * 0.22;

            semanaContent += `
                <div class="resumo-extra" style="border-top: none; padding-top: 0;">
                    <p>Total Bruto: <strong>R$ ${totalBrutoSemana.toFixed(2)}</strong></p>
                    <p>Emergenciais: <strong>R$ ${emergencialSemana.toFixed(2)}</strong></p>
                    <p>Subtotal: <strong>R$ ${subtotalSemana.toFixed(2)}</strong></p>
                    <p>Comiss√£o: <strong>R$ ${comissaoSemana.toFixed(2)}</strong></p>
                </div>
            `;

            // Adiciona tabela de entregas da semana
            semanaContent += `
                <table style="width: 100%; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleSelectAllHistorico(this, ${idx})" aria-label="Selecionar todos da semana" /></th>
                            <th>Nome</th>
                            <th>Valor (R$)</th>
                            <th>Pago</th>
                            <th>Coletado</th> <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            if (semanaRecord.dados.length === 0) {
                semanaContent += `<tr><td colspan="6">Nenhum registro de entrega para esta semana.</td></tr>`;
            } else {
                semanaRecord.dados.forEach((entrega, entregaIdx) => {
                    semanaContent += `
                        <tr>
                            <td><input type="checkbox" class="historico-checkbox" data-semana-idx="${idx}" data-entrega-idx="${entregaIdx}" aria-label="Selecionar registro" /></td>
                            <td>${entrega.nome}</td>
                            <td>R$ ${entrega.valor.toFixed(2)}</td>
                            <td>${entrega.pago ? 'Sim' : 'N√£o'}</td>
                            <td>${entrega.coletado ? 'Sim' : 'N√£o'}</td> <td>${entrega.data}</td>
                        </tr>
                    `;
                });
            }
            semanaContent += `</tbody></table>`;

            // Adiciona detalhes de caixa e gasolina da semana
            const totalCaixaSemana = calcularTotal(semanaRecord.caixaLancamentos);
            const totalGasolinaSemana = calcularTotal(semanaRecord.gasolinaLancamentos);

            semanaContent += `
                <div class="resumo-extra">
                    <p>Total Caixa (troco): <strong id="caixaResumoTotalSemana_${idx}">R$ ${totalCaixaSemana.toFixed(2)}</strong></p>
                    <div class="detalhes-container">
                        <h4>Detalhes do Caixa (troco) da Semana</h4>
                        <ul>
            `;
            if (semanaRecord.caixaLancamentos && semanaRecord.caixaLancamentos.length > 0) {
                semanaRecord.caixaLancamentos.forEach(item => {
                    semanaContent += `<li><span>${formatarDataParaExibicao(item.data)}</span> <span class="valor">R$ ${item.valor.toFixed(2)}</span></li>`;
                });
            } else {
                semanaContent += `<li>Nenhum lan√ßamento de caixa para esta semana.</li>`;
            }
            semanaContent += `
                        </ul>
                    </div>
                    <p style="margin-top:10px;">Total Gasolina: <strong id="gasolinaResumoTotalSemana_${idx}">R$ ${totalGasolinaSemana.toFixed(2)}</strong></p>
                    <div class="detalhes-container">
                        <h4>Detalhes da Gasolina da Semana</h4>
                        <ul>
            `;
            if (semanaRecord.gasolinaLancamentos && semanaRecord.gasolinaLancamentos.length > 0) {
                semanaRecord.gasolinaLancamentos.forEach(item => {
                    semanaContent += `<li><span>${formatarDataParaExibicao(item.data)}</span> <span class="valor">R$ ${item.valor.toFixed(2)}</span></li>`;
                });
            } else {
                semanaContent += `<li>Nenhum lan√ßamento de gasolina para esta semana.</li>`;
            }
            semanaContent += `
                        </ul>
                    </div>
                </div>
            `;
            historicoDiv.innerHTML += `<div class="historico-semana">${semanaContent}</div>`;
        });
    }

    // Fun√ß√µes de manipula√ß√£o do hist√≥rico
    function toggleSelectAllHistorico(checkbox, semanaIndex) {
        const checkboxes = document.querySelectorAll(`#historico [data-semana-idx="${semanaIndex}"]`);
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    function apagarSelecionados() {
        if (!confirm("Tem certeza que deseja apagar os registros selecionados?")) return;

        const checkboxes = document.querySelectorAll('.historico-checkbox:checked');
        const paraRemover = []; // Array de objetos { semanaIndex, entregaIndex }

        checkboxes.forEach(cb => {
            const semanaIdx = parseInt(cb.dataset.semanaIdx);
            const entregaIdx = parseInt(cb.dataset.entregaIdx);
            paraRemover.push({ semanaIdx, entregaIdx });
        });

        // Agrupa por semana para remover de tr√°s para frente e n√£o bagun√ßar os √≠ndices
        const agrupadoPorSemana = paraRemover.reduce((acc, item) => {
            acc[item.semanaIdx] = acc[item.semanaIdx] || [];
            acc[item.semanaIdx].push(item.entregaIdx);
            return acc;
        }, {});

        for (const semanaIdxStr in agrupadoPorSemana) {
            const semanaIdx = parseInt(semanaIdxStr);
            // Ordena os √≠ndices das entregas em ordem decrescente para remover sem problemas
            const indicesEntregas = agrupadoPorSemana[semanaIdx].sort((a, b) => b - a);

            indicesEntregas.forEach(entregaIdx => {
                if (historico[semanaIdx] && historico[semanaIdx].dados) {
                    historico[semanaIdx].dados.splice(entregaIdx, 1);
                }
            });
            // Se a semana ficar vazia de entregas, voc√™ pode considerar remov√™-la,
            // mas o c√≥digo atual mant√©m a semana vazia para mostrar outros dados (caixa, gasolina)
        }

        localStorage.setItem("historico", JSON.stringify(historico));
        aplicarFiltroHistorico(); // Re-renderiza o hist√≥rico
        alert("Registros selecionados apagados!");
    }

    function apagarFiltrados() {
        if (!confirm("Tem certeza que deseja apagar TODOS os registros filtrados?")) return;

        // Cria uma lista dos √≠ndices originais das semanas que *n√£o* est√£o no filtro atual
        const semanasParaManter = historico.filter((_, idx) => {
            return !historicoFiltradoAtual.some(filteredRecord => filteredRecord.originalIndex === idx);
        });

        historico = semanasParaManter; // Substitui o hist√≥rico pelo que deve ser mantido

        localStorage.setItem("historico", JSON.stringify(historico));
        aplicarFiltroHistorico(); // Re-renderiza o hist√≥rico, agora vazio ou com menos itens
        alert("Registros filtrados apagados!");
    }

    function apagarTodosHistorico() {
        if (confirm("Tem certeza que deseja apagar TODO o hist√≥rico de registros? Esta a√ß√£o √© irrevers√≠vel.")) {
            historico = [];
            localStorage.setItem("historico", "[]");
            aplicarFiltroHistorico();
            alert("Todo o hist√≥rico de registros foi apagado.");
        }
    }

    function enviarMensagemGeral() {
        const naoPagosComTelefone = entregas.filter(e => !e.pago && e.telefone);
        if (naoPagosComTelefone.length === 0) {
            alert("N√£o h√° clientes n√£o pagos e com telefone registrado para enviar mensagem.");
            return;
        }

        let mensagem = "Ol√°! Gostar√≠amos de lembrar que sua pend√™ncia conosco ainda n√£o foi paga.\n\nDetalhes:\n";
        naoPagosComTelefone.forEach(e => {
            mensagem += `\n- Cliente: ${e.nome}\n  Descri√ß√£o: ${e.descricao}\n  Valor: R$ ${e.valor.toFixed(2)}\n`;
        });
        mensagem += "\nPor favor, entre em contato para regularizar. Obrigado!";

        const confirmSend = confirm("Ser√° gerada uma mensagem geral para os clientes n√£o pagos. Copie a lista de telefones abaixo e cole no WhatsApp. Deseja continuar?");
        if (confirmSend) {
            alert("Mensagem pronta. Por favor, copie a lista de telefones e cole no WhatsApp para enviar.");
        }
    }

    // Inicializa a renderiza√ß√£o quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', () => {
        showPage('principal'); // Mostra a p√°gina principal por padr√£o
        // Se voc√™ quiser que o app sempre comece mostrando "principal", "pagos", etc.,
        // apenas chame a fun√ß√£o correspondente aqui:
        // showPage('principal');
    });

</script>

</body>
</html>
